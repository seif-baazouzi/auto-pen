import NavBar from "../../components/NavBar"
import ajax from "../../utils/ajax"
import { parseCookies } from "../../utils/cookies"
import Animation from "../../components/Animation"
import ReactMarkdown from "react-markdown"
import Head from "next/head"

const titleStyles = {
  color: "var(--dark-gray)"
}

export default function Scan({ id, scan }) {
  return (
    <>
      <Head>
        <title>Report scan {id}</title>
      </Head>
      <NavBar />
      <Animation>
        <div className="container">
          <h3 style={titleStyles}>Scan ID: {id}</h3>
          {
            scan ?
              <div className="mark-down">
                <ReactMarkdown>{scan.report}</ReactMarkdown>
              </div>
            :
              <p>404 not found</p>
          }
        </div>
      </Animation>
    </>
  )
}

export async function getServerSideProps(context) {
  const cookies = parseCookies(context.req.headers.cookie)
  
  if(!cookies.token) {
    return {
      redirect: { permanent: false, destination: "/login" }
    }
  }

  const { id } = context.query
  const res = await ajax.get(`/api/v1/scans/${id}`, { token: cookies.token })
  
  if(res.message === "invalid-token") {
    return {
      redirect: { permanent: false, destination: "/login" }
    }
  }
  
  return {
    props: {
      id,
      scan: res.scan
    }
  }
}
