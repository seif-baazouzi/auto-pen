const express = require("express")
const signup = express.Router()

const bcrypt = require("bcrypt")

const User = require("../../models/user")
const tokens = require("../../utils/tokens")
const trycatch = require("../../utils/try-catch")
const checkParams = require("../../utils/check-params")
const { checkSignup } = require("../../utils/auth-tests")

signup.post("/", checkParams(["name", "email", "password"]), async (req, res) => {
  trycatch(req, res, async () => {
    const { name, email, password } = req.body
    const { isValid, errors } = await checkSignup(name, email, password)
    
    // return errors
    if(!isValid) return res.json(errors)

    // hash password
    const hash = await bcrypt.hash(password, 10)

    // insert user
    const user = new User({ name, email, password: hash })
    user.save()
    
    res.json({ token: tokens.get(user._id) })
  })
})

module.exports = signup
