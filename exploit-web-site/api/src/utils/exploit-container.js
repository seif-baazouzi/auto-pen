const http = require('http')

const getResults = (buffer) => {
  const results = buffer.toString()
  return JSON.parse(results)
}

function startExploitContainer(scanID, url, cookies) {
  return new Promise((resolve, reject) => {
    const data = JSON.stringify({ url, cookies })
    const options = {
      hostname: process.env.HOST_IP,
      port: 4444,
      path: `/${scanID}`,
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': data.length,
      },
    }
    
    const req = http.request(options, res => {    
      res.on('data', d => {
        resolve(getResults(d))
      })
    })
    
    req.on('error', error => {
      results = error.toString()
      reject(getResults(error))
    })

    req.write(data)
    req.end()
  })
}

module.exports = startExploitContainer