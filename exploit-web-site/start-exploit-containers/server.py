import os
import json
from flask import Flask, request

app = Flask(__name__)

network = os.getenv("DOCKER_NETWORK")

def escaping(s):
  return s.replace("'", "\\'")

@app.post("/<scanID>")
def startContainer(scanID):
  try:
    url = request.json["url"]
    cookies = request.json["cookies"]
    
    cmd = """
      docker run --add-host "api.hardening.auto-pen.local:172.17.0.1" --network %s exploit bash -c "./app.py --all --url '%s' --cookies '%s'; python -c 'import requests; f=open(\\"report.md\\"); requests.patch(f\\"http://save-reports:4444/%s\\", json={ \\"report\\": f.read() }); f.close()'" &
    """ % (network, escaping(url), escaping(cookies), scanID)

    os.system(cmd)

    return json.dumps({ "message": "success" })
  except Exception as e:
    print(e)
    return json.dumps({ "message": "try-again" })

if __name__ == "__main__":
  app.run(debug=True, port=4444, host="172.17.0.1")
