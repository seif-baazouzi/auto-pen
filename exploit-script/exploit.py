from log import impr

from report import generateReport
from report.save import saveReport
from utils.tmpDir import cleanTmpDir
from utils.cookies import parseCookies
from modules.scraping import scrapingModule

def exploit(args):
  results = {}
  cookies = parseCookies(args.cookies)
  
  technologies = []

  cleanTmpDir()

  if args.all or args.nmap:
    from modules.nmap import nmapModule
    results["nmapTechnologies"] = nmapModule(args.url)
    technologies = [ *results["nmapTechnologies"] ]
    print()

  if args.all or args.webtech:
    from modules.webtech import webtechModule
    results["webtechtechnologies"] = webtechModule(args.url)
    
    if "nmapTechnologies" in results:
      technologies = [
        *results["nmapTechnologies"],
        *results["webtechtechnologies"],
      ]
    else:
      technologies = [ *results["webtechtechnologies"] ]
    
    print()
  
  if args.all or args.cves:
    from modules.cves import cvesModule
    results["cvss"] = cvssModule(technologies)
    print()

  if args.all or args.waf:
    from modules.waf import wafModule
    results["waf"] = wafModule(args.url)
    print()

  if args.all or args.cors:
    from modules.cors import corsModule
    results["cors"] = corsModule(args.url)
    print()

  urls, forms = scrapingModule(args.url, cookies)
  print()

  if args.all or args.lfi:
    from modules.lfi import lfiModule
    results["lfi"] = lfiModule(urls, forms, cookies)
    print()
  
  if args.all or args.xss:
    from modules.xss import xssModule
    results["xss"] = xssModule(urls, forms, cookies)
    print()

  if args.all or args.sqli:
    from modules.sqli import sqliModule
    results["sqli"] = sqliModule(urls, args.cookies)
    print()

  if args.all or args.cmd_injection:
    from modules.cmdInjection import cmdInjectionModule
    results["cmdInjection"] = cmdInjectionModule(urls, forms, cookies)
    print()

  if args.all or args.tmp_injection:
    from modules.tmpInjection import tmpInjectionModule
    results["tmpInjection"] = tmpInjectionModule(urls, forms, cookies)
    print()

  if args.all or args.priv_esc:
    if "cmdInjection" in results:
      from modules.privEsc import privEscModule
      results["privEsc"] = privEscModule(results["cmdInjection"])
      print()
    else:
      impr("Priv-esc module is required by cmd-injection module")
      results["privEsc"] = "Priv-esc module is required by cmd-injection module"
      print()

  if args.all or args.backups:
    from modules.backups import backupsModule
    results["backups"] = backupsModule(urls)
    print()
  
  if args.all or args.hardening:
    from modules.hardening import hardeningModule
    results["hardening"] = hardeningModule(technologies)
    print()

  # delete the testing 404 page
  urls.pop()

  report = generateReport(
    urls,
    forms,
    results
  )
  saveReport(report, args.output)
  print()

  cleanTmpDir()
