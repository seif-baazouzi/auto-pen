import time
import threading

from log import impr, info, warn
from utils.parsePrivEscLogFile import parsePrivEscLogFile
from .tools import getServer, startServer, closeServer, tryUploadAndRunClient

def privEscModule(cmdInjectionResults):
  info("Privilege Escalation")

  reflectedResults, blindResults = cmdInjectionResults
  if len(reflectedResults) == 0 and len(blindResults) == 0:
    message = "There is no command injection points"
    warn(message)
    return message
  
  t = threading.Thread(target=startServer).start()
  server = getServer()

  time.sleep(1)

  if not tryUploadAndRunClient(server, reflectedResults, blindResults):
    closeServer(server)
    message = "Faild to start the test"
    impr(message)
    return message
  
  while threading.active_count() != 1:
    time.sleep(.01)

  results = parsePrivEscLogFile()
  if not results:
    warn("All good!")
  else:
    for title in results:
      info(title)
      logs = results[title]
      for log in logs:
        if "message" in log:
          impr(log["message"])
        
        for script in log["scripts"]:
          print("```")
          print("\n".join([ "$ " + line for line in script.split("\n") if line ]))
          print("```\n")
