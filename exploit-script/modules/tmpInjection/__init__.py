from utils.exploitloop import exploitLoop
from log import impr, bold, red, warn, info
from .tools import payloads, RANDOM_VALUE

###########################################################################
###########################################################################

def checkResponseFunction(res):
  return RANDOM_VALUE in res.text

###########################################################################
###########################################################################

def foundExploitCallback(res, kind):
  if kind == "url":
    impr(
      f"In the url {res.urlWithPayload} the {res.kind} "
      f"param `{bold(res.getParamName())}` {red(bold('is vulnerable'))}"
    )
  else:
    impr(
      f"In the url {res.form.url} the form {res.form.method} {res.form.action} "
      f"field `{bold(res.field)}` {red(bold('is vulnerable'))} with payload {bold(res.payload)}"
    )

###########################################################################
###########################################################################

def tmpInjectionModule(urls, forms, cookies):
  info(bold("Testing for Template Injection"))
  
  results = exploitLoop(urls, forms, cookies, payloads, checkResponseFunction, foundExploitCallback)

  if len(results) == 0:
    warn("No Template Injection found")
  
  return results
