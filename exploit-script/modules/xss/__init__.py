from utils.exploitloop import exploitLoop
from log import impr, bold, red, warn, info
from .tools import payloads, getJSResult, closeDriver

###########################################################################
###########################################################################

def checkResponseFunction(res):
  jsResponse = getJSResult(res.text, "return window.randomTestXssProp")
  return jsResponse == 1234

###########################################################################
###########################################################################

def foundExploitCallback(res, kind):
  if kind == "url":
    impr(
      f"In the url {res.urlWithPayload} the {res.kind} "
      f"param `{bold(res.getParamName())}` {red(bold('is vulnerable'))}"
    )
  else:
    impr(
      f"In the url {res.form.url} the form {res.form.method} {res.form.action} "
      f"field `{bold(res.field)}` {red(bold('is vulnerable'))} with payload {bold(res.payload)}"
    )

###########################################################################
###########################################################################

def xssModule(urls, forms, cookies):
  info(bold("Testing for XSS"))
  results = exploitLoop(urls, forms, cookies, payloads, checkResponseFunction, foundExploitCallback)
  closeDriver()
  
  if len(results) == 0:
    warn("No XSS found")

  return results
