import os
from urllib.parse import urlparse
from xml.dom.minidom import parse

import log 
from utils.technologies import Technologie

###########################################################################
###########################################################################

def getHostName(url):
  uri = urlparse(url)
  return uri.hostname

###########################################################################
###########################################################################

def getTechnologies():
  tecnologies = []

  document = parse("tmp/nmap.xml")
  ports = document.getElementsByTagName("port")

  for port in ports:
    service = port.getElementsByTagName("service")[0]
    product = service.getAttribute("product")
    if not product:
      continue
    
    if service.hasAttribute("version"):
      version = service.getAttribute("version")
    else:
      version = None

    tecnologies.append(Technologie(product, version))

  return tecnologies

###########################################################################
###########################################################################

def runScan(hostname):
  cmd = f"nmap -sC -sV -T4 -v -Pn -oN tmp/nmap -oX tmp/nmap.xml {hostname}"
  log.cmd(cmd)
  os.system(cmd)
